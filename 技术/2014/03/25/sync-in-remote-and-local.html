<!DOCTYPE html> <html class='borderbox'> <head> <meta charset="utf-8"> <meta name="viewport" content="width=device-width"> <meta http-equiv="X-UA-Compatible" content="IE=edge"> <title>服务器和本地的文件同步</title> <meta name="description" content="这是我的中文博客，记录自己在技术、生活等方面的一些感想。博客叫 Storm Spirit， 因为我特别喜欢 Dota 里蓝猫这个英雄，可惜玩得不好…… 希望自己能够通过博客，得到成长。 "> <link rel="stylesheet" href="/css/main.css"> <link rel="canonical" href="http://wwulfric.github.io/%E6%8A%80%E6%9C%AF/2014/03/25/sync-in-remote-and-local.html"> <script src="/js/jquery-2.1.1.min.js"></script> <script src="/js/jquery.modal.min.js"></script> <script src="/js/main.js"></script> </head> <body> <div class='content'> <header> <a class="site-title" href="/">Storm Spirit</a> </header> <div class="post typo"> <header class="post-header clearfix"> <div class='date pull-left clearfix'> <div class='day-month pull-left'> <div class='day'>25</div> <div class='month'>MAR</div> </div> <div class='year pull-left'>2014</div> </div> <h1 class="post-title">服务器和本地的文件同步</h1> </header> <blockquote id='by-nc-nd'> 声明: 本文采用 <a href="http://creativecommons.org/licenses/by-nc-nd/4.0/deed.zh_TW" rel="nofollow" target="_blank" title="姓名标示-非商业性-禁止改作4.0国际">CC BY-NC-ND 4.0</a> 授权。 </blockquote> <article class="post-content"> <p>在开发的时候经常会有这样的情形：在本地做 Git 操作和代码编辑工作，然后在远程服务器/虚拟机上做调试，这样可以保持本地环境的整洁。有以下几种待选方案：</p> <ul> <li>利用 samba 将远程文件夹挂载到本地</li> <li>利用 Rsync/sftp 或其它工具建立本地文件夹和远程文件夹的双向同步</li> <li>利用 Rsync/sftp 将本地文件夹同步到远端</li> </ul> <!--more--> <h2 id="samba">Samba</h2> <p><figure> <a class='post-image' rel='post-image' href='http://wulfric.qiniudn.com/samba.png'> <img src="http://wulfric.qiniudn.com/samba.png" alt="Samba" title="Samba" /> </a> <figcaption>Samba</figcaption> </figure></p> <p>在网速比较好的情况下，samba 是一个比较优秀的解决方案。它将远程的文件夹加载到本地，可以保持本地和远程文件内容的一致性。</p> <p>本文安装方法参考了<a href="https://rbgeek.wordpress.com/2012/05/25/how-to-install-samba-server-on-centos-6/">这篇文章</a>。以下配置可以在虚拟机安装时通过脚本自动完成。</p> <h3 id="安装">安装</h3> <div class="highlight"><pre><code class="language-bash"><span class="nb">cd</span> ~
<span class="c1"># 安装 samba</span>
sudo apt-get install samba
<span class="c1"># yum: sudo yum install samba</span>
<span class="c1"># 备份 samba 配置文件</span>
sudo cp /etc/samba/smb.conf /etc/samba/smb.conf_back
<span class="c1"># 修改配置文件，具体内容见下文。</span>
sudo vim /etc/samba/smb.conf
<span class="c1"># 或者 sudo rm /etc/samba/smb.conf &amp;&amp; sudo touch /etc/samba/smb.conf 新建一个配置文件</span>

<span class="c1"># 关闭 selinux</span>
sudo vim /etc/selinux/config
<span class="c1"># 设置：SELINUX=disabled</span>

<span class="c1"># 配置 iptables</span>
sudo iptables -I INPUT <span class="m">4</span> -m state --state NEW -m udp -p udp --dport <span class="m">137</span> -j ACCEPT
sudo iptables -I INPUT <span class="m">5</span> -m state --state NEW -m udp -p udp --dport <span class="m">138</span> -j ACCEPT
sudo iptables -I INPUT <span class="m">6</span> -m state --state NEW -m tcp -p tcp --dport <span class="m">139</span> -j ACCEPT
sudo service iptables save
sudo service iptables restart</code></pre></div> <h3 id="普通配置">普通配置</h3> <p>如果服务器是在信任的局域网中，那么可以跳过权限验证，使用简单的guest 来挂载。</p> <div class="highlight"><pre><code class="language-shell">mkdir guest_share
ls -l
<span class="c1"># 通过查看可以知道 guest_share 的权限是 775，guest 没有写权限，这会导致本地只能读而不能写</span>
<span class="c1"># 修改权限</span>
sudo chmod -R <span class="m">777</span> guest_share</code></pre></div> <p>编辑配置文件。</p> <div class="highlight"><pre><code class="language-shell"><span class="c1"># /etc/samba/smb.conf</span>

<span class="c1">#======================= Global Settings ======================</span>
<span class="o">[</span>global<span class="o">]</span>
 <span class="nv">workgroup</span> <span class="o">=</span> WORKGROUP
 <span class="nv">security</span> <span class="o">=</span> share
 map to <span class="nv">guest</span> <span class="o">=</span> bad user
<span class="c1">#======================= Share Definitions ====================</span>
<span class="o">[</span>MyShare<span class="o">]</span>
 <span class="nv">path</span> <span class="o">=</span> /home/username/guest_share
 <span class="nv">browsable</span> <span class="o">=</span>yes
 <span class="nv">writable</span> <span class="o">=</span> yes
 guest <span class="nv">ok</span> <span class="o">=</span> yes
 <span class="nb">read</span> <span class="nv">only</span> <span class="o">=</span> no</code></pre></div> <p>重启。</p> <div class="highlight"><pre><code class="language-shell"><span class="c1"># 查看配置文件的内容有没有错误，如果有重要的配置丢失，可能是因为缩进不对</span>
sudo testparm
sudo service smb restart
sudo service nmb restart</code></pre></div> <p>在本地获取该共享文件夹</p> <ul> <li> <p>MAC: finder -&gt; 前往 -&gt; 连接服务器 -&gt; smb://你的IP/share</p> </li> <li> <p>WINDOWS: 资源管理器 -&gt; 输入 \\你的IP\share</p> </li> </ul> <p>其中 share 是配置文件中的配置名：如上所述的[MyShare]</p> <h3 id="安全配置">安全配置</h3> <p>如果是远程的服务器，安全起见，最好还是能够用帐号和密码登录。</p> <div class="highlight"><pre><code class="language-shell"><span class="c1"># 创建组</span>
sudo groupadd smbgrp
<span class="c1"># 创建用户</span>
sudo useradd smbuser
<span class="c1"># 更改用户密码</span>
sudo passwd smbuser
<span class="c1"># 用户添加到组</span>
sudo usermod -a -G smbgrp smbuser
<span class="c1"># 添加 samba 的登录密码</span>
sudo smbpasswd -a smbuser
<span class="c1"># 创建要分享的文件夹</span>
<span class="nb">cd</span> ~
mkdir secure_share
sudo chown -R smbuser:smbgrp secure_share
sudo chmod -R <span class="m">770</span> secure_share</code></pre></div> <p>编辑配置文件，注意差别，security 从 share 改为 user<sup id="fnref:share_level"><a href="#fn:share_level" class="footnote">1</a></sup>。</p> <div class="highlight"><pre><code class="language-shell"><span class="c1"># /etc/samba/smb.conf</span>

<span class="c1">#======================= Global Settings ======================</span>
<span class="o">[</span>global<span class="o">]</span>
 <span class="nv">workgroup</span> <span class="o">=</span> WORKGROUP
 <span class="nv">security</span> <span class="o">=</span> user
 map to <span class="nv">guest</span> <span class="o">=</span> bad user
<span class="c1">#======================= Share Definitions ====================</span>
<span class="o">[</span>MyShare<span class="o">]</span>
 <span class="nv">path</span> <span class="o">=</span> /home/username/guest_share
 <span class="nv">browsable</span> <span class="o">=</span>yes
 <span class="nv">writable</span> <span class="o">=</span> yes
 guest <span class="nv">ok</span> <span class="o">=</span> yes
 <span class="nb">read</span> <span class="nv">only</span> <span class="o">=</span> no
<span class="o">[</span>Secure<span class="o">]</span>
 <span class="nv">path</span> <span class="o">=</span> /home/username/secure_share
 valid <span class="nv">users</span> <span class="o">=</span> @smbgrp
 guest <span class="nv">ok</span> <span class="o">=</span> no
 <span class="nv">writable</span> <span class="o">=</span> yes
 <span class="nv">browsable</span> <span class="o">=</span> yes</code></pre></div> <p>然后检查参数并重启 samba。在本地选择使用注册用户登录 samba。</p> <h3 id="缺点">缺点</h3> <p>在本地新建和删除文件的时候略有卡顿，对网络的稳定性要求较高。</p> <h2 id="rsync">Rsync</h2> <p>本地和服务器都需要安装 Rsync。这种工作方式对网络的实时性需求不是很高，而且相对于 sftp，rsync 是增量更新，对带宽的需求更小。</p> <p><figure> <a class='post-image' rel='post-image' href='http://wulfric.qiniudn.com/rsync.jpg'> <img src="http://wulfric.qiniudn.com/rsync.jpg" alt="rsync" /> </a> <figcaption>rsync</figcaption> </figure></p> <p>一般编辑器都有 rsync 的插件，对于 sublime text 就是 <a href="https://sublime.wbond.net/packages/RSync">RSync</a>。</p> <p>值得注意的是，MAC 的系统是 Case-insenstive 的，因此使用 git 作版本控制时，重命名操作会出现问题。一个解决方案是，利用 MAC 自带的 Disk Utility 工具，创建一个 Case-senstive 的 new image<sup id="fnref:case_sensitivity"><a href="#fn:case_sensitivity" class="footnote">2</a></sup>。</p> <div class="footnotes"> <ol> <li id="fn:share_level"> <p>samba 有多种 <a href="https://www.samba.org/samba/docs/man/Samba-HOWTO-Collection/ServerType.html">share level</a>&nbsp;<a href="#fnref:share_level" class="reversefootnote">&#8617;</a></p> </li> <li id="fn:case_sensitivity"> <p>参见<a href="http://stackoverflow.com/questions/8904327/case-sensitivity-in-git">讨论</a>&nbsp;<a href="#fnref:case_sensitivity" class="reversefootnote">&#8617;</a></p> </li> </ol> </div> </article> <div id='additional' class='clearfix'> <div id="tags" class='pull-left'> samba, 远程, remote, server, rsync, ubuntu, centos </div> <a class='pull-right' href="#comments" rel="modal:open">评论</a> </div> <div id="comments"> <!-- 多说评论框 start --> <div class="ds-thread" data-thread-key="/%E6%8A%80%E6%9C%AF/2014/03/25/sync-in-remote-and-local.html" data-title="服务器和本地的文件同步" data-url="http://wwulfric.github.io/%E6%8A%80%E6%9C%AF/2014/03/25/sync-in-remote-and-local.html"></div> <!-- 多说评论框 end --> <!-- 多说公共JS代码 start (一个网页只需插入一次) --> <script type="text/javascript"> var duoshuoQuery = {short_name:"storm-spirit"}; (function() { var ds = document.createElement('script'); ds.type = 'text/javascript';ds.async = true; ds.src = (document.location.protocol == 'https:' ? 'https:' : 'http:') + '//static.duoshuo.com/embed.js'; ds.charset = 'UTF-8'; (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(ds); })(); </script> <!-- 多说公共JS代码 end --> </div> </div> <footer> <a class="page-link" href="/about/">wulfric</a> © 2013~2014. All rights reserved. </footer> <script> (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){ (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o), m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m) })(window,document,'script','//www.google-analytics.com/analytics.js','ga'); ga('create', 'UA-54608037-1', 'auto'); ga('send', 'pageview'); </script> </div> </body> </html>
